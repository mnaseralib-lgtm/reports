<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <title>ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø§Ù†ØµØ±Ø§Ù</title>
    <style>
        body {font-family: "Cairo", sans-serif; margin: 20px; direction: rtl; text-align: right;}
        select, input, button {
            padding: 8px; margin: 5px; border: 1px solid #ccc; border-radius: 4px;
            font-size: 14px;
        }
        table {width: 100%; border-collapse: collapse; margin-top: 15px;}
        th, td {border: 1px solid #ddd; padding: 8px; text-align: center;}
        th {background-color: #f2f2f2;}
        .hidden {display: none;}
        .message {color: red; margin-top: 10px; font-weight: bold;}
        .loading {color: blue; margin-top: 10px;}
        .container {max-width: 1400px; margin: 0 auto;}
        .form-section {background: #f9f9f9; padding: 15px; border-radius: 5px; margin-bottom: 20px;}
        .success {color: green;}
        .employee-info {background: #e7f3ff; padding: 10px; border-radius: 5px; margin: 10px 0;}
    </style>
</head>
<body>
    <div class="container">
        <h2>ğŸ“Š Ù†Ø¸Ø§Ù… ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø§Ù†ØµØ±Ø§Ù</h2>

        <!-- Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ± -->
        <div class="form-section">
            <label for="reportType"><strong>Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ±:</strong></label>
            <select id="reportType" onchange="toggleReportForm()">
                <option value="employee">ØªÙ‚Ø±ÙŠØ± Ù…ÙˆØ¸Ù ÙØ±Ø¯ÙŠ</option>
                <option value="day">ØªÙ‚Ø±ÙŠØ± ÙŠÙˆÙ… Ù…Ø¹ÙŠÙ†</option>
                <option value="period">ØªÙ‚Ø±ÙŠØ± ÙØªØ±Ø© Ù…Ø¬Ù…Ø¹</option>
            </select>
        </div>

        <!-- Ù†Ù…ÙˆØ°Ø¬ ØªÙ‚Ø±ÙŠØ± Ù…ÙˆØ¸Ù -->
        <div id="employeeReportForm" class="form-section">
            <h3>ğŸ¯ ØªÙ‚Ø±ÙŠØ± Ù…ÙˆØ¸Ù ÙØ±Ø¯ÙŠ</h3>
            <label><strong>ÙƒÙˆØ¯ Ø§Ù„Ù…ÙˆØ¸Ù:</strong></label>
            <input type="text" id="employeeId" placeholder="Ø§Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ù…ÙˆØ¸Ù">
            <label><strong>Ù…Ù†:</strong></label>
            <input type="date" id="fromDate">
            <label><strong>Ø¥Ù„Ù‰:</strong></label>
            <input type="date" id="toDate">
            <button onclick="fetchEmployeeReport()" style="background: #4CAF50; color: white;">Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
            
            <div id="employeeInfo" class="employee-info hidden"></div>
        </div>

        <!-- Ù†Ù…ÙˆØ°Ø¬ ØªÙ‚Ø±ÙŠØ± ÙŠÙˆÙ… Ù…Ø¹ÙŠÙ† -->
        <div id="dayReportForm" class="form-section hidden">
            <h3>ğŸ“… ØªÙ‚Ø±ÙŠØ± ÙŠÙˆÙ… Ù…Ø¹ÙŠÙ†</h3>
            <label><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong></label>
            <input type="date" id="singleDay">
            <button onclick="fetchDayReport()" style="background: #2196F3; color: white;">Ø¹Ø±Ø¶ ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…</button>
        </div>

        <!-- Ù†Ù…ÙˆØ°Ø¬ ØªÙ‚Ø±ÙŠØ± ÙØªØ±Ø© (Ù…Ø¬Ù…Ø¹) -->
        <div id="periodReportForm" class="form-section hidden">
            <h3>ğŸ“Š ØªÙ‚Ø±ÙŠØ± ÙØªØ±Ø© Ù…Ø¬Ù…Ø¹</h3>
            <label><strong>Ù…Ù†:</strong></label>
            <input type="date" id="periodFrom">
            <label><strong>Ø¥Ù„Ù‰:</strong></label>
            <input type="date" id="periodTo">
            <button onclick="fetchPeriodReport()" style="background: #FF9800; color: white;">Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø¬Ù…Ø¹</button>
        </div>

        <div id="message" class="message"></div>
        <div id="loading" class="loading hidden">â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>

        <!-- Ø¬Ø¯ÙˆÙ„ Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ -->
        <div id="resultsSection" class="hidden">
            <h3>ğŸ“‹ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</h3>
            <table id="resultsTable">
                <thead id="tableHead"></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        // âš ï¸ Ø¶Ø¹ Ø±Ø§Ø¨Ø· Ø§Ù„Ù†Ø´Ø± Ù‡Ù†Ø§
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyS4iCtGpTVNtL8qeu_wN-CtvEdPPaMe8CUDKwEZ08Hv4PlMxKfHszziZYZU8G1TCVCdg/exec";

        function toggleReportForm() {
            const type = document.getElementById("reportType").value;
            document.getElementById("employeeReportForm").classList.toggle("hidden", type !== "employee");
            document.getElementById("dayReportForm").classList.toggle("hidden", type !== "day");
            document.getElementById("periodReportForm").classList.toggle("hidden", type !== "period");
            document.getElementById("message").innerHTML = "";
            document.getElementById("resultsSection").classList.add("hidden");
            document.getElementById("employeeInfo").classList.add("hidden");
        }

        function showLoading(show) {
            document.getElementById("loading").classList.toggle("hidden", !show);
        }

        function showMessage(message, isError = true) {
            const messageEl = document.getElementById("message");
            messageEl.innerHTML = message;
            messageEl.className = isError ? 'message' : 'message success';
        }

        function showEmployeeInfo(employee) {
            const infoEl = document.getElementById("employeeInfo");
            infoEl.innerHTML = `
                <strong>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù:</strong><br>
                Ø§Ù„ÙƒÙˆØ¯: ${employee.employee_id} | Ø§Ù„Ø§Ø³Ù…: ${employee.name} | Ø§Ù„Ù…Ù‡Ù†Ø©: ${employee.occupation}
            `;
            infoEl.classList.remove("hidden");
        }

        // âœ… Ø¬Ù„Ø¨ ØªÙ‚Ø±ÙŠØ± Ù…ÙˆØ¸Ù
        async function fetchEmployeeReport() {
            const emp = document.getElementById("employeeId").value.trim();
            const from = document.getElementById("fromDate").value;
            const to = document.getElementById("toDate").value;

            if (!emp || !from || !to) {
                showMessage("âš  ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„.");
                return;
            }

            showLoading(true);
            showMessage("");
            document.getElementById("employeeInfo").classList.add("hidden");

            try {
                const url = `${SCRIPT_URL}?action=singleReport&employee_id=${emp}&from=${from}&to=${to}`;
                const res = await fetch(url);
                const data = await res.json();

                if (data.error) {
                    showMessage("âš  " + data.error);
                    document.getElementById("resultsSection").classList.add("hidden");
                    return;
                }

                if (!data.days || data.days.length === 0) {
                    showMessage("âš  Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©.");
                    document.getElementById("resultsSection").classList.add("hidden");
                    return;
                }

                showMessage(`âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${data.days.length} ÙŠÙˆÙ…`, false);
                showEmployeeInfo(data.days[0]);
                
                renderTable(
                    ["Ø§Ù„ØªØ§Ø±ÙŠØ®", "Ø§Ù„Ø¯Ø®ÙˆÙ„", "Ø§Ù„Ø§Ù†ØµØ±Ø§Ù", "Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„", "Ø§Ù„Ø£ÙˆÙØ± ØªØ§ÙŠÙ…", "Ø¹Ø¯Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª"],
                    data.days.map(d => [
                        d.date,
                        d.first_in,
                        d.last_out,
                        d.work_hours_str,
                        d.overtime_hours_str,
                        d.entries_count || "0"
                    ])
                );
            } catch (error) {
                showMessage("âš  Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: " + error.message);
            } finally {
                showLoading(false);
            }
        }

        // âœ… Ø¬Ù„Ø¨ ØªÙ‚Ø±ÙŠØ± ÙŠÙˆÙ…ÙŠ
        async function fetchDayReport() {
            const day = document.getElementById("singleDay").value;
            if (!day) {
                showMessage("âš  ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØªØ§Ø±ÙŠØ®.");
                return;
            }

            showLoading(true);
            showMessage("");

            try {
                const url = `${SCRIPT_URL}?action=dayReport&day=${day}`;
                const res = await fetch(url);
                const data = await res.json();

                if (data.error) {
                    showMessage("âš  " + data.error);
                    return;
                }

                if (!data || data.length === 0) {
                    showMessage("âš  Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ….");
                    return;
                }

                showMessage(`âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${data.length} Ù…ÙˆØ¸Ù`, false);
                renderTable(
                    ["ÙƒÙˆØ¯ Ø§Ù„Ù…ÙˆØ¸Ù", "Ø§Ù„Ø§Ø³Ù…", "Ø§Ù„Ù…Ù‡Ù†Ø©", "Ø§Ù„Ø¯Ø®ÙˆÙ„", "Ø§Ù„Ø§Ù†ØµØ±Ø§Ù", "Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„", "Ø§Ù„Ø£ÙˆÙØ± ØªØ§ÙŠÙ…", "Ø¹Ø¯Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª"],
                    data.map(d => [
                        d.employee_id,
                        d.name,
                        d.occupation,
                        d.first_in,
                        d.last_out,
                        d.work_hours_str,
                        d.overtime_hours_str,
                        d.entries_count || "0"
                    ])
                );
            } catch (error) {
                showMessage("âš  Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: " + error.message);
            } finally {
                showLoading(false);
            }
        }

        // âœ… Ø¬Ù„Ø¨ ØªÙ‚Ø±ÙŠØ± Ù…Ø¬Ù…Ø¹
        async function fetchPeriodReport() {
            const from = document.getElementById("periodFrom").value;
            const to = document.getElementById("periodTo").value;
            if (!from || !to) {
                showMessage("âš  ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙØªØ±Ø©.");
                return;
            }

            showLoading(true);
            showMessage("");

            try {
                const url = `${SCRIPT_URL}?action=periodReport&from=${from}&to=${to}`;
                const res = await fetch(url);
                const data = await res.json();

                if (data.error) {
                    showMessage("âš  " + data.error);
                    return;
                }

                if (!data || Object.keys(data).length === 0) {
                    showMessage("âš  Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙ‰ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©.");
                    return;
                }

                // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙƒØ§Ø¦Ù† Ø¥Ù„Ù‰ Ù…ØµÙÙˆÙØ©
                const employeesArray = Object.keys(data).map(empId => {
                    const empData = data[empId];
                    return {
                        employee_id: empId,
                        name: empData.name,
                        occupation: empData.occupation,
                        days_present: empData.days_present || 0,
                        total_work_hours_str: empData.total_work_hours_str || "0:00",
                        total_overtime_hours_str: empData.total_overtime_hours_str || "0:00"
                    };
                });

                showMessage(`âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${employeesArray.length} Ù…ÙˆØ¸Ù`, false);
                
                renderTable(
                    ["ÙƒÙˆØ¯ Ø§Ù„Ù…ÙˆØ¸Ù", "Ø§Ù„Ø§Ø³Ù…", "Ø§Ù„Ù…Ù‡Ù†Ø©", "Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ø¶ÙˆØ±", "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„", "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ÙˆÙØ± ØªØ§ÙŠÙ…"],
                    employeesArray.map(d => [
                        d.employee_id,
                        d.name,
                        d.occupation,
                        d.days_present,
                        d.total_work_hours_str,
                        d.total_overtime_hours_str
                    ])
                );
            } catch (error) {
                showMessage("âš  Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: " + error.message);
            } finally {
                showLoading(false);
            }
        }

        // âœ… Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„
        function renderTable(headers, rows) {
            const thead = document.getElementById("tableHead");
            const tbody = document.getElementById("tableBody");
            const resultsSection = document.getElementById("resultsSection");

            thead.innerHTML = `<tr>${headers.map(h => `<th>${h}</th>`).join("")}</tr>`;
            tbody.innerHTML = rows.map(r => `<tr>${r.map(c => `<td>${c}</td>`).join("")}</tr>`).join("");

            resultsSection.classList.remove("hidden");
        }

        // ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
        window.onload = function() {
            const today = new Date().toISOString().split('T')[0];
            const firstDay = new Date();
            firstDay.setDate(1);
            const firstDayStr = firstDay.toISOString().split('T')[0];
            
            // ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
            document.getElementById('fromDate').value = firstDayStr;
            document.getElementById('toDate').value = today;
            document.getElementById('singleDay').value = today;
            document.getElementById('periodFrom').value = firstDayStr;
            document.getElementById('periodTo').value = today;
        };
    </script>
</body>
</html>
