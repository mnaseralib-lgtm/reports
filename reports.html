<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <title>تقارير الحضور والانصراف</title>
    <style>
        body {font-family: "Cairo", sans-serif; margin: 20px; direction: rtl; text-align: right;}
        select, input, button {
            padding: 8px; margin: 5px; border: 1px solid #ccc; border-radius: 4px;
            font-size: 14px;
        }
        table {width: 100%; border-collapse: collapse; margin-top: 15px;}
        th, td {border: 1px solid #ddd; padding: 8px; text-align: center;}
        th {background-color: #f2f2f2;}
        .hidden {display: none;}
        .message {color: red; margin-top: 10px; font-weight: bold;}
        .loading {color: blue; margin-top: 10px;}
        .container {max-width: 1200px; margin: 0 auto;}
        .form-section {background: #f9f9f9; padding: 15px; border-radius: 5px; margin-bottom: 20px;}
        .debug {background: #fff3cd; padding: 10px; margin: 10px 0; border-radius: 5px; font-family: monospace; font-size: 12px;}
    </style>
</head>
<body>
    <div class="container">
        <h2>📊 نظام التقارير</h2>

        <!-- اختيار نوع التقرير -->
        <div class="form-section">
            <label for="reportType">اختر نوع التقرير:</label>
            <select id="reportType" onchange="toggleReportForm()">
                <option value="employee">تقرير موظف</option>
                <option value="day">تقرير يوم معين</option>
                <option value="period">تقرير مجمع لفترة</option>
            </select>
        </div>

        <!-- نموذج تقرير موظف -->
        <div id="employeeReportForm" class="form-section">
            <h3>تقرير موظف فردي</h3>
            <label>كود الموظف:</label>
            <input type="text" id="employeeId" placeholder="ادخل الكود">
            <label>من:</label>
            <input type="date" id="fromDate">
            <label>إلى:</label>
            <input type="date" id="toDate">
            <button onclick="fetchEmployeeReport()">عرض التقرير</button>
        </div>

        <!-- نموذج تقرير يوم معين -->
        <div id="dayReportForm" class="form-section hidden">
            <h3>تقرير يوم معين</h3>
            <label>التاريخ:</label>
            <input type="date" id="singleDay">
            <button onclick="fetchDayReport()">عرض تقرير اليوم</button>
        </div>

        <!-- نموذج تقرير فترة (مجمع) -->
        <div id="periodReportForm" class="form-section hidden">
            <h3>تقرير فترة مجمع</h3>
            <label>من:</label>
            <input type="date" id="periodFrom">
            <label>إلى:</label>
            <input type="date" id="periodTo">
            <button onclick="fetchPeriodReport()">عرض التقرير المجمع</button>
        </div>

        <div id="message" class="message"></div>
        <div id="loading" class="loading hidden">جاري تحميل البيانات...</div>

        <!-- معلومات التصحيح -->
        <div id="debugInfo" class="debug hidden"></div>

        <!-- جدول عرض النتائج -->
        <table id="resultsTable" class="hidden">
            <thead id="tableHead"></thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>

    <script>
        // ⚠️ ضع رابط النشر هنا
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwHnqytZNw6SI_Hwqso4Y1OTW6p-PhxsQckvoLJJL_9giWzjaoVSaBNkjt4XtDRPaYZJQ/exec";

        function toggleReportForm() {
            const type = document.getElementById("reportType").value;
            document.getElementById("employeeReportForm").classList.toggle("hidden", type !== "employee");
            document.getElementById("dayReportForm").classList.toggle("hidden", type !== "day");
            document.getElementById("periodReportForm").classList.toggle("hidden", type !== "period");
            document.getElementById("message").innerHTML = "";
            document.getElementById("resultsTable").classList.add("hidden");
            document.getElementById("debugInfo").classList.add("hidden");
        }

        function showLoading(show) {
            document.getElementById("loading").classList.toggle("hidden", !show);
        }

        function showMessage(message, isError = true) {
            const messageEl = document.getElementById("message");
            messageEl.innerHTML = message;
            messageEl.style.color = isError ? 'red' : 'green';
        }

        function showDebugInfo(info) {
            const debugEl = document.getElementById("debugInfo");
            debugEl.innerHTML = `<strong>معلومات التصحيح:</strong><br>${info}`;
            debugEl.classList.remove("hidden");
        }

        // ✅ جلب تقرير موظف
        async function fetchEmployeeReport() {
            const emp = document.getElementById("employeeId").value.trim();
            const from = document.getElementById("fromDate").value;
            const to = document.getElementById("toDate").value;

            if (!emp || !from || !to) {
                showMessage("⚠ يرجى ملء جميع الحقول.");
                return;
            }

            showLoading(true);
            showMessage("");
            document.getElementById("debugInfo").classList.add("hidden");

            try {
                const url = `${SCRIPT_URL}?action=singleReport&employee_id=${emp}&from=${from}&to=${to}`;
                console.log('Request URL:', url);
                
                const res = await fetch(url);
                const data = await res.json();

                console.log('Response data:', data);

                if (data.error) {
                    showMessage("⚠ " + data.error);
                    document.getElementById("resultsTable").classList.add("hidden");
                    return;
                }

                if (!data.days || data.days.length === 0) {
                    showMessage("⚠ لا توجد بيانات مطابقة.");
                    document.getElementById("resultsTable").classList.add("hidden");
                    // عرض معلومات التصحيح
                    showDebugInfo(`تم البحث عن: الموظف ${emp} من ${from} إلى ${to}<br>عدد الأيام: 0`);
                    return;
                }

                showMessage(`✅ تم العثور على ${data.days.length} يوم`, false);
                
                // إخفاء معلومات التصحيح في الإصدار النهائي
                // showDebugInfo(JSON.stringify(data.days, null, 2));
                
                renderTable(
                    ["التاريخ", "الكود", "الاسم", "المهنة", "الدخول", "الخروج", "ساعات العمل", "الأوفر تايم"],
                    data.days.map(d => [
                        d.date, d.employee_id, d.name, d.occupation,
                        d.first_in, d.last_out, d.work_hours_str, d.overtime_hours_str
                    ])
                );
            } catch (error) {
                showMessage("⚠ حدث خطأ في جلب البيانات: " + error.message);
                console.error('Error:', error);
            } finally {
                showLoading(false);
            }
        }

        // ✅ جلب تقرير يومي
        async function fetchDayReport() {
            const day = document.getElementById("singleDay").value;
            if (!day) {
                showMessage("⚠ يرجى اختيار تاريخ.");
                return;
            }

            showLoading(true);
            showMessage("");
            document.getElementById("debugInfo").classList.add("hidden");

            try {
                const url = `${SCRIPT_URL}?action=dayReport&day=${day}`;
                console.log('Request URL:', url);
                
                const res = await fetch(url);
                const data = await res.json();

                console.log('Response data:', data);

                if (data.error) {
                    showMessage("⚠ " + data.error);
                    return;
                }

                if (!data || data.length === 0) {
                    showMessage("⚠ لا توجد بيانات لهذا اليوم.");
                    showDebugInfo(`تم البحث عن التاريخ: ${day}<br>عدد الموظفين: 0`);
                    return;
                }

                showMessage(`✅ تم العثور على ${data.length} موظف`, false);
                renderTable(
                    ["الكود", "الاسم", "المهنة", "الدخول", "الخروج", "ساعات العمل", "الأوفر تايم"],
                    data.map(d => [
                        d.employee_id, d.name, d.occupation,
                        d.first_in, d.last_out, d.work_hours_str, d.overtime_hours_str
                    ])
                );
            } catch (error) {
                showMessage("⚠ حدث خطأ في جلب البيانات: " + error.message);
                console.error('Error:', error);
            } finally {
                showLoading(false);
            }
        }

        // ✅ جلب تقرير مجمع
        async function fetchPeriodReport() {
            const from = document.getElementById("periodFrom").value;
            const to = document.getElementById("periodTo").value;
            if (!from || !to) {
                showMessage("⚠ يرجى تحديد الفترة.");
                return;
            }

            showLoading(true);
            showMessage("");
            document.getElementById("debugInfo").classList.add("hidden");

            try {
                const url = `${SCRIPT_URL}?action=periodReport&from=${from}&to=${to}`;
                console.log('Request URL:', url);
                
                const res = await fetch(url);
                const data = await res.json();

                console.log('Response data:', data);

                if (data.error) {
                    showMessage("⚠ " + data.error);
                    return;
                }

                if (!data || Object.keys(data).length === 0) {
                    showMessage("⚠ لا توجد بيانات فى هذه الفترة.");
                    showDebugInfo(`تم البحث من ${from} إلى ${to}<br>عدد الموظفين: 0`);
                    return;
                }

                // تحويل الكائن إلى مصفوفة
                const employeesArray = Object.keys(data).map(empId => {
                    const empData = data[empId];
                    return {
                        ...empData,
                        employee_id: empId
                    };
                });

                showMessage(`✅ تم العثور على ${employeesArray.length} موظف`, false);
                
                renderTable(
                    ["الكود", "الاسم", "المهنة", "عدد الأيام", "إجمالي العمل", "إجمالي الأوفر"],
                    employeesArray.map(d => [
                        d.employee_id, d.name, d.occupation,
                        d.days_present || 0, d.total_work_hours_str || "0:00", d.total_overtime_hours_str || "0:00"
                    ])
                );
            } catch (error) {
                showMessage("⚠ حدث خطأ في جلب البيانات: " + error.message);
                console.error('Error:', error);
            } finally {
                showLoading(false);
            }
        }

        // ✅ دالة عرض الجدول
        function renderTable(headers, rows) {
            const thead = document.getElementById("tableHead");
            const tbody = document.getElementById("tableBody");
            const table = document.getElementById("resultsTable");

            thead.innerHTML = `<tr>${headers.map(h => `<th>${h}</th>`).join("")}</tr>`;
            tbody.innerHTML = rows.map(r => `<tr>${r.map(c => `<td>${c}</td>`).join("")}</tr>`).join("");

            table.classList.remove("hidden");
        }

        // تعيين التواريخ الافتراضية
        window.onload = function() {
            const today = new Date().toISOString().split('T')[0];
            const firstDay = new Date();
            firstDay.setDate(1);
            const firstDayStr = firstDay.toISOString().split('T')[0];
            
            // تعيين التواريخ الافتراضية
            document.getElementById('fromDate').value = firstDayStr;
            document.getElementById('toDate').value = today;
            document.getElementById('singleDay').value = today;
            document.getElementById('periodFrom').value = firstDayStr;
            document.getElementById('periodTo').value = today;
        };
    </script>
</body>
</html>
