<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø¶ÙˆØ±</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#10b981"/>
<style>
  body{font-family:Arial, sans-serif;background:#f3f4f6;color:#111;padding:0;margin:0;direction:rtl}
  .app{display:flex;min-height:100vh}
  .sidebar{width:72px;background:#06212a;color:#fff;display:flex;flex-direction:column;align-items:center;padding:12px;gap:12px}
  .sidebar a{color:#fff;text-decoration:none;font-size:12px;text-align:center}
  .main{flex:1;padding:18px}
  .card{max-width:720px;margin:18px auto;background:#fff;padding:18px;border-radius:12px;box-shadow:0 6px 24px rgba(0,0,0,0.08)}
  h1{font-size:20px;margin:0 0 10px}
  .controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap;justify-content:center;margin-bottom:12px}
  select,input[type=text]{padding:10px;border-radius:8px;border:1px solid #e5e7eb;font-size:15px}
  button{padding:10px 14px;border-radius:8px;border:none;background:#3b82f6;color:#fff;font-weight:600;cursor:pointer}
  #exportBtn{background:#06b6d4}
  #syncBtn{background:#8b5cf6}
  #reader{width:100%;max-width:480px;margin:8px auto;border-radius:10px;overflow:hidden;background:#000}
  .confirmation-message{position:fixed;top:18px;left:50%;transform:translateX(-50%);background:rgba(16,185,129,0.97);color:#fff;padding:10px 18px;border-radius:10px;z-index:9999;display:none;font-weight:700}
  .error-message{position:fixed;top:18px;left:50%;transform:translateX(-50%);background:rgba(239,68,68,0.97);color:#fff;padding:10px 18px;border-radius:10px;z-index:9999;display:none;font-weight:700}
  .counter{font-weight:700;color:#065f46}
  .manual-row{display:flex;gap:8px;justify-content:center;align-items:center;margin-top:10px;flex-wrap:wrap}
  .small{font-size:13px;color:#6b7280}
  .link-icon{writing-mode:vertical-rl;transform:rotate(180deg);font-weight:700}
  .pending-badge{background:#f59e0b;color:white;padding:2px 6px;border-radius:10px;font-size:11px;margin-left:5px}
  @media (max-width:720px){ .sidebar{display:flex;width:56px} }
</style>
</head>
<body>
<div class="app">
  <nav class="sidebar" role="navigation" aria-label="Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©">
    <a href="index.html" title="Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©">ğŸ <div style="font-size:11px;margin-top:6px">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div></a>
    <a href="reports.html" title="Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±">ğŸ“Š<div style="font-size:11px;margin-top:6px">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</div></a>
    <a href="#" id="offlineStatus" title="Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„">âš¡<div style="font-size:11px;margin-top:6px">Ù…ØªØµÙ„</div></a>
  </nav>

  <main class="main">
    <div class="card">
    <center><h1>Abo Qir Metro JV Orascom & Colas rails</h1></center>
      <div class="controls" role="region" aria-label="Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª">
        <label for="movementSelect" class="small">Ù†ÙˆØ¹ Ø§Ù„Ø­Ø±ÙƒØ©:</label>
        <select id="movementSelect" aria-label="Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ø­Ø±ÙƒØ©">
          <option value="">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø­Ø±ÙƒØ©</option>
          <option value="Ø¯Ø®ÙˆÙ„">Ø¯Ø®ÙˆÙ„</option>
          <option value="Ø§Ù†ØµØ±Ø§Ù">Ø§Ù†ØµØ±Ø§Ù</option>
          <option value="Ø§Ù†ØµØ±Ø§Ù Ù…Ø³Ø§Ø¦ÙŠ">Ø§Ù†ØµØ±Ø§Ù Ù…Ø³Ø§Ø¦ÙŠ</option>
        </select>

        <div class="counter" id="scanCount">Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø³Ø¬Ù„Ø©: 0 <span id="pendingCount" class="pending-badge" style="display:none">0</span></div>

        <button id="stopBtn" style="background:#ef4444">Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø§Ø³Ø­</button>
        <button id="startBtn" style="background:#10b981">ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø§Ø³Ø­</button>
        <button id="syncBtn">Ù…Ø²Ø§Ù…Ù†Ø©</button>
      </div>

      <div id="reader" aria-live="polite"></div>

      <div class="manual-row">
        <input type="text" id="manualInput" placeholder="Ø¥Ø¯Ø®Ø§Ù„ ÙŠØ¯ÙˆÙŠ - Ø±Ù‚Ù… Ø£Ùˆ Ø§Ø³Ù…" aria-label="Ø¥Ø¯Ø®Ø§Ù„ ÙŠØ¯ÙˆÙŠ">
        <button id="manualAddBtn">Ø¥Ø¶Ø§ÙØ© ÙŠØ¯ÙˆÙŠ</button>
      </div>

      <div style="text-align:center;margin-top:14px">
        <button id="exportBtn">ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Excel (CSV)</button>
      </div>

      <p class="small" style="margin-top:12px;text-align:center"> HR Department <code></code></p>
    </div>

    <div id="confirmMsg" class="confirmation-message" role="status" aria-live="polite"></div>
    <div id="errorMsg" class="error-message" role="alert" aria-live="polite"></div>
  </main>
</div>

<script src="https://unpkg.com/html5-qrcode"></script>
<script>
// ---------------- CONFIG ----------------
const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzeBugfSme93srGaJa5h5Kf_pFreNh9PgB39WAYq_VFryNRR2u8eMUkgaIwHNiVy0zA1A/exec';

// ---------------- State ----------------
let records = [];
let pendingRecords = [];
let scanCount = 0;
let currentScanner = null;
let lastScannedId = null;
let lastScannedAt = 0;
const DEBOUNCE_MS = 1500;

// Beep sound
const beepBase64 = "UklGRuQAAABXQVZFZm10IBAAAAABAAEAgD4AAAB9AAACABAAZGF0YcQAAACAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA=";
const beepSound = new Audio("data:audio/wav;base64," + beepBase64);
beepSound.volume = 1.0;
function playBeep(){ try{ beepSound.currentTime = 0; beepSound.play(); }catch(e){ console.warn('beep failed', e); } try{ if(navigator.vibrate) navigator.vibrate(180); } catch(e){} }

function showConfirmation(record){ 
  const msg = document.getElementById('confirmMsg');
  msg.textContent = `âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ ${record.movement_type} Ù„Ù€ ${record.employee_id}`;
  msg.style.display = 'block'; 
  setTimeout(()=>{ msg.style.display = 'none'; }, 2000); 
}

function showError(message) {
  const msg = document.getElementById('errorMsg');
  msg.textContent = message;
  msg.style.display = 'block';
  setTimeout(()=>{ msg.style.display = 'none'; }, 3000);
}

function updateCounter(){ 
  document.getElementById('scanCount').innerText = 'Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø³Ø¬Ù„Ø©: ' + scanCount; 
  const pendingEl = document.getElementById('pendingCount');
  if (pendingRecords.length > 0) {
    pendingEl.textContent = pendingRecords.length;
    pendingEl.style.display = 'inline';
  } else {
    pendingEl.style.display = 'none';
  }
}

function createLocalRecord(employeeId, movement){ 
  const now = new Date();
  return { 
    id: `local-${Date.now()}-${Math.random().toString(36).slice(2,8)}`,
    employee_id: String(employeeId).trim(), 
    movement_type: movement, 
    timestamp: now.toISOString(),
    source: 'QR'
  }; 
}

// Scanner functions
function startScanner(){ 
  if(currentScanner) return; 
  const readerId = "reader"; 
  const html5Qr = new Html5Qrcode(readerId); 
  currentScanner = html5Qr; 
  const config = { fps: 10, qrbox: { width: 250, height: 250 } };
  
  Html5Qrcode.getCameras().then(devices => {
    if(devices && devices.length){
      const rear = devices.find(d => (d.label||'').toLowerCase().includes('back') || (d.label||'').toLowerCase().includes('rear')) || devices[0];
      html5Qr.start(rear.id || { facingMode: "environment" }, config, qrCodeMessage => {
        const now = Date.now();
        if(qrCodeMessage === lastScannedId && (now - lastScannedAt) < DEBOUNCE_MS) return;
        lastScannedId = qrCodeMessage; 
        lastScannedAt = now;
        html5Qr.stop().then(()=>{ 
          currentScanner = null; 
          handleScanned(qrCodeMessage); 
          setTimeout(()=> startScanner(), 600); 
        }).catch(err=>{ 
          currentScanner = null; 
          handleScanned(qrCodeMessage); 
          setTimeout(()=> startScanner(), 600); 
        });
      }, errorMessage => {}).catch(err=>{ 
        console.error('start failed', err); 
        showError('Ø®Ø·Ø£: Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª.');
      });
    } else { 
      showError('Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙƒØ§Ù…ÙŠØ±Ø§.');
    }
  }).catch(err=>{ 
    console.error('cameras error', err); 
    showError('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§');
  }); 
}

function stopScanner(){ 
  if(!currentScanner) return; 
  currentScanner.stop().then(()=>{ 
    try{ currentScanner.clear(); }catch(e){}; 
    currentScanner = null; 
    showConfirmation({movement_type: '', employee_id: 'ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø§Ø³Ø­.'});
  }).catch(err=>{ 
    console.warn('stop err', err); 
    currentScanner = null; 
  }); 
}

function handleScanned(qr){ 
  const movement = document.getElementById('movementSelect').value; 
  if(!movement){ 
    showError('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ø­Ø±ÙƒØ© Ø£ÙˆÙ„Ø§Ù‹.');
    return; 
  }
  
  const record = createLocalRecord(qr, movement); 
  records.unshift(record);
  pendingRecords.push(record);
  scanCount++; 
  updateCounter(); 
  saveLocally(); 
  sendToGoogle([record]); 
  playBeep(); 
  showConfirmation(record); 
}

function manualAdd(){ 
  const val = document.getElementById('manualInput').value; 
  const movement = document.getElementById('movementSelect').value; 
  if(!movement){ 
    alert('Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø­Ø±ÙƒØ© Ø£ÙˆÙ„Ø§Ù‹'); 
    return; 
  } 
  if(!val || String(val).trim()===''){ 
    alert('Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø£Ùˆ Ø§Ø³Ù… ØµØ§Ù„Ø­'); 
    return; 
  } 
  
  const record = createLocalRecord(val, movement); 
  records.unshift(record);
  pendingRecords.push(record);
  scanCount++; 
  updateCounter(); 
  saveLocally(); 
  sendToGoogle([record]); 
  playBeep(); 
  showConfirmation(record); 
  document.getElementById('manualInput').value=''; 
}

function saveLocally(){ 
  try{ 
    localStorage.setItem('attendance_records_final', JSON.stringify(records));
    localStorage.setItem('pending_records_final', JSON.stringify(pendingRecords));
  }catch(e){} 
}

function loadLocally(){ 
  try{ 
    const s = localStorage.getItem('attendance_records_final');
    const p = localStorage.getItem('pending_records_final');
    
    if(s){ 
      records = JSON.parse(s); 
      scanCount = records.length; 
    }
    
    if(p) {
      pendingRecords = JSON.parse(p);
    }
    
    updateCounter(); 
  }catch(e){} 
}

function exportToExcel(){ 
  const data = records.slice().sort((a,b)=> new Date(b.timestamp) - new Date(a.timestamp)); 
  const headers = ['Ù…Ø¹Ø±Ù Ø§Ù„Ø³Ø¬Ù„','Ø±Ù…Ø² Ø§Ù„Ù…ÙˆØ¸Ù','Ù†ÙˆØ¹ Ø§Ù„Ø­Ø±ÙƒØ©','Ø§Ù„ÙˆÙ‚Øª','Ø§Ù„Ù…ØµØ¯Ø±', 'Ø§Ù„Ø­Ø§Ù„Ø©']; 
  let csv = headers.join(',') + '\n'; 
  const esc = v => { 
    if(v==null) return ''; 
    let s = String(v); 
    if(s.includes(',')||s.includes('\n')||s.includes('"')) return '"' + s.replace(/"/g,'""') + '"'; 
    return s; 
  };
  
  data.forEach(r=>{ 
    const status = !pendingRecords.find(p => p.id === r.id) ? 'Ù…Ø²Ø§Ù…Ù†' : 'ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±';
    csv += [esc(r.id), esc(r.employee_id), esc(r.movement_type), esc(new Date(r.timestamp).toLocaleString('en-US',{hour12:false})), esc(r.source), esc(status)].join(',') + '\n'; 
  });
  
  const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' }); 
  const a = document.createElement('a'); 
  a.href = URL.createObjectURL(blob); 
  a.download = `Attendance_Records_${new Date().toISOString().slice(0,10)}.csv`; 
  document.body.appendChild(a); 
  a.click(); 
  a.remove(); 
}

// Ø¯Ø§Ù„Ø© Ù…Ø­Ø³Ù†Ø© ØªÙ…Ø§Ù…Ø§Ù‹ Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
function sendToGoogle(recordsToSend) {
  if (!navigator.onLine) {
    console.log('Offline - record saved locally only');
    return;
  }

  // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† recordsToSend Ù‡ÙŠ Ù…ØµÙÙˆÙØ©
  if (!Array.isArray(recordsToSend)) {
    recordsToSend = [recordsToSend];
  }

  console.log('Sending records to Google:', recordsToSend);

  // Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© 1: Ø¥Ø±Ø³Ø§Ù„ ÙƒÙ…ØµÙÙˆÙØ© Ù…Ø¨Ø§Ø´Ø±Ø© (Ø§Ù„Ø£ÙØ¶Ù„)
  const payload = JSON.stringify(recordsToSend);

  fetch(GOOGLE_SCRIPT_URL, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: payload
  })
  .then(response => {
    console.log('Response status:', response.status);
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    return response.json();
  })
  .then(result => {
    console.log('Server response:', result);
    if (result.success) {
      // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªÙŠ ØªÙ…Øª Ù…Ø²Ø§Ù…Ù†ØªÙ‡Ø§ Ø¨Ù†Ø¬Ø§Ø­
      const syncedIds = result.saved_records.map(r => r.id);
      pendingRecords = pendingRecords.filter(record => !syncedIds.includes(record.id));
      
      updateCounter();
      saveLocally();
      console.log('Records synced successfully:', syncedIds.length);
      
      if (recordsToSend.length === 1) {
        showConfirmation({...recordsToSend[0], status: 'Ù…Ø²Ø§Ù…Ù†'});
      }
    } else {
      console.error('Server reported error:', result.error);
      showError(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…: ${result.error}`);
    }
  })
  .catch(error => {
    console.error('Network error:', error);
    // Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© 2: Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¯ÙŠÙ„Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… FormData
    retryWithFormData(recordsToSend);
  });
}

// Ø·Ø±ÙŠÙ‚Ø© Ø¨Ø¯ÙŠÙ„Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… FormData
function retryWithFormData(recordsToSend) {
  console.log('Retrying with FormData...');
  
  const formData = new URLSearchParams();
  formData.append('records_batch', JSON.stringify(recordsToSend));

  fetch(GOOGLE_SCRIPT_URL, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
    },
    body: formData
  })
  .then(response => response.json())
  .then(result => {
    console.log('FormData response:', result);
    if (result.success) {
      const syncedIds = result.saved_records.map(r => r.id);
      pendingRecords = pendingRecords.filter(record => !syncedIds.includes(record.id));
      updateCounter();
      saveLocally();
    }
  })
  .catch(error => {
    console.error('FormData also failed:', error);
    // Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø³ØªØ¨Ù‚Ù‰ ÙÙŠ pendingRecords Ù„Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹
  });
}

// Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù…Ø­Ø³Ù†Ø©
function syncPendingRecords() {
  if (pendingRecords.length === 0) {
    showConfirmation({movement_type: '', employee_id: 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø©'});
    return;
  }

  if (!navigator.onLine) {
    showError('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª. Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©.');
    return;
  }

  showConfirmation({movement_type: '', employee_id: `Ø¬Ø§Ø±ÙŠ Ù…Ø²Ø§Ù…Ù†Ø© ${pendingRecords.length} Ø³Ø¬Ù„...`});

  console.log('Syncing pending records:', pendingRecords);

  // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø©
  const payload = JSON.stringify(pendingRecords);

  fetch(GOOGLE_SCRIPT_URL, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: payload
  })
  .then(response => {
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    return response.json();
  })
  .then(result => {
    console.log('Sync response:', result);
    if (result.success) {
      // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªÙŠ ØªÙ…Øª Ù…Ø²Ø§Ù…Ù†ØªÙ‡Ø§ Ø¨Ù†Ø¬Ø§Ø­
      const syncedIds = result.saved_records.map(r => r.id);
      pendingRecords = pendingRecords.filter(record => !syncedIds.includes(record.id));
      
      updateCounter();
      saveLocally();
      showConfirmation({movement_type: '', employee_id: `ØªÙ…Øª Ù…Ø²Ø§Ù…Ù†Ø© ${result.saved_count} Ø³Ø¬Ù„ Ø¨Ù†Ø¬Ø§Ø­`});
    } else {
      showError(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©: ${result.error}`);
    }
  })
  .catch(error => {
    console.error('Sync error:', error);
    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ù€ FormData
    const formData = new URLSearchParams();
    formData.append('records_batch', JSON.stringify(pendingRecords));

    fetch(GOOGLE_SCRIPT_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      body: formData
    })
    .then(response => response.json())
    .then(result => {
      if (result.success) {
        const syncedIds = result.saved_records.map(r => r.id);
        pendingRecords = pendingRecords.filter(record => !syncedIds.includes(record.id));
        updateCounter();
        saveLocally();
        showConfirmation({movement_type: '', employee_id: `ØªÙ…Øª Ù…Ø²Ø§Ù…Ù†Ø© ${result.saved_count} Ø³Ø¬Ù„ Ø¨Ù†Ø¬Ø§Ø­`});
      } else {
        showError(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©: ${result.error}`);
      }
    })
    .catch(finalError => {
      console.error('Final sync error:', finalError);
      showError('ÙØ´Ù„ ÙÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ ÙˆØ­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
    });
  });
}

// Init & Controls
document.getElementById('startBtn').addEventListener('click', startScanner);
document.getElementById('stopBtn').addEventListener('click', stopScanner);
document.getElementById('manualAddBtn').addEventListener('click', manualAdd);
document.getElementById('exportBtn').addEventListener('click', exportToExcel);
document.getElementById('syncBtn').addEventListener('click', syncPendingRecords);

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
loadLocally();

// Service Worker registration for PWA
if('serviceWorker' in navigator){ 
  window.addEventListener('load', ()=>{ 
    navigator.serviceWorker.register('service-worker.js')
      .then(()=>console.log('SW registered'))
      .catch(()=>{}); 
  }); 
}

// Update offline status and auto-sync when back online
function updateOnlineStatus(){ 
  const el = document.getElementById('offlineStatus'); 
  el.innerHTML = navigator.onLine ? 
    'âš¡<div style="font-size:11px;margin-top:6px">Ù…ØªØµÙ„</div>' : 
    'â›”<div style="font-size:11px;margin-top:6px">ØºÙŠØ± Ù…ØªØµÙ„</div>'; 
    
  // Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø¹Ù†Ø¯ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„
  if (navigator.onLine && pendingRecords.length > 0) {
    setTimeout(() => {
      showConfirmation({movement_type: '', employee_id: 'Ø§Ù„Ø§ØªØµØ§Ù„ Ù…ØªØ§Ø­ - Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©...'});
      syncPendingRecords();
    }, 2000);
  }
}

window.addEventListener('online', updateOnlineStatus); 
window.addEventListener('offline', updateOnlineStatus); 
updateOnlineStatus();

// Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
window.addEventListener('load', function() {
  fetch(GOOGLE_SCRIPT_URL + '?action=dayReport&day=2024-01-01')
    .then(response => {
      if (response.ok) {
        console.log('Connection to Google Apps Script is working');
      } else {
        console.warn('Connection test failed');
      }
    })
    .catch(error => {
      console.error('Connection test error:', error);
    });
});
</script>
</body>
</html>
