<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø¶ÙˆØ±</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#10b981"/>
<style>
  body{font-family:Arial, sans-serif;background:#f3f4f6;color:#111;padding:0;margin:0;direction:rtl}
  .app{display:flex;min-height:100vh}
  .sidebar{width:72px;background:#06212a;color:#fff;display:flex;flex-direction:column;align-items:center;padding:12px;gap:12px}
  .sidebar a{color:#fff;text-decoration:none;font-size:12px;text-align:center}
  .main{flex:1;padding:18px}
  .card{max-width:720px;margin:18px auto;background:#fff;padding:18px;border-radius:12px;box-shadow:0 6px 24px rgba(0,0,0,0.08)}
  h1{font-size:20px;margin:0 0 10px}
  .controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap;justify-content:center;margin-bottom:12px}
  select,input[type=text]{padding:10px;border-radius:8px;border:1px solid #e5e7eb;font-size:15px}
  button{padding:10px 14px;border-radius:8px;border:none;background:#3b82f6;color:#fff;font-weight:600;cursor:pointer}
  #exportBtn{background:#06b6d4}
  #reader{width:100%;max-width:480px;margin:8px auto;border-radius:10px;overflow:hidden;background:#000}
  .confirmation-message{position:fixed;top:18px;left:50%;transform:translateX(-50%);background:rgba(16,185,129,0.97);color:#fff;padding:10px 18px;border-radius:10px;z-index:9999;display:none;font-weight:700}
  .counter{font-weight:700;color:#065f46}
  .manual-row{display:flex;gap:8px;justify-content:center;align-items:center;margin-top:10px;flex-wrap:wrap}
  .small{font-size:13px;color:#6b7280}
  .link-icon{writing-mode:vertical-rl;transform:rotate(180deg);font-weight:700}
  @media (max-width:720px){ .sidebar{display:flex;width:56px} }
</style>
</head>
<body>
<div class="app">
  <nav class="sidebar" role="navigation" aria-label="Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©">
    <a href="index.html" title="Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©">ğŸ <div style="font-size:11px;margin-top:6px">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div></a>
    <a href="reports.html" title="Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±">ğŸ“Š<div style="font-size:11px;margin-top:6px">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</div></a>
    <a href="#" id="offlineStatus" title="Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„">âš¡<div style="font-size:11px;margin-top:6px">Ù…ØªØµÙ„</div></a>
  </nav>

  <main class="main">
    <div class="card">
    <center><h1>Abo Qir Metro JV Orascom & Colas rails</h1></center>
      <div class="controls" role="region" aria-label="Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª">
        <label for="movementSelect" class="small">Ù†ÙˆØ¹ Ø§Ù„Ø­Ø±ÙƒØ©:</label>
        <select id="movementSelect" aria-label="Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ø­Ø±ÙƒØ©">
          <option value="">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø­Ø±ÙƒØ©</option>
          <option value="Ø¯Ø®ÙˆÙ„">Ø¯Ø®ÙˆÙ„</option>
          <option value="Ø§Ù†ØµØ±Ø§Ù">Ø§Ù†ØµØ±Ø§Ù</option>
          <option value="Ø§Ù†ØµØ±Ø§Ù Ù…Ø³Ø§Ø¦ÙŠ">Ø§Ù†ØµØ±Ø§Ù Ù…Ø³Ø§Ø¦ÙŠ</option>
        </select>

        <div class="counter" id="scanCount">Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø³Ø¬Ù„Ø©: 0</div>

        <button id="stopBtn" style="background:#ef4444">Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø§Ø³Ø­</button>
        <button id="startBtn" style="background:#10b981">ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø§Ø³Ø­</button>
      </div>

      <div id="reader" aria-live="polite"></div>

      <div class="manual-row">
        <input type="text" id="manualInput" placeholder="Ø¥Ø¯Ø®Ø§Ù„ ÙŠØ¯ÙˆÙŠ - Ø±Ù‚Ù… Ø£Ùˆ Ø§Ø³Ù…" aria-label="Ø¥Ø¯Ø®Ø§Ù„ ÙŠØ¯ÙˆÙŠ">
        <button id="manualAddBtn">Ø¥Ø¶Ø§ÙØ© ÙŠØ¯ÙˆÙŠ</button>
      </div>

      <div style="text-align:center;margin-top:14px">
        <button id="exportBtn">ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Excel (CSV)</button>
      </div>

      <p class="small" style="margin-top:12px;text-align:center"> HR Department <code></code></p>
    </div>

    <div id="confirmMsg" class="confirmation-message" role="status" aria-live="polite"></div>
  </main>
</div>

<script src="https://unpkg.com/html5-qrcode"></script>
<script>
// ---------------- CONFIG ----------------
// Ø¶Ø¹ Ù‡Ù†Ø§ Ø±Ø§Ø¨Ø· Web App Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ (Apps Script) â€” Ø¹Ø¯Ù‘Ù„Ù‡ Ø¥Ù„Ù‰ Ø±Ø§Ø¨Ø·Ùƒ Ù‚Ø¨Ù„ Ø§Ù„Ù†Ø´Ø±
const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxsg5pXgLCDgQKumsTMHq6q83AtZAOqWty57g49rUylPVKghKsu2Pwuuxxf3mnQFtgHmQ/exec';

// ---------------- State ----------------
let records = [];
let scanCount = 0;
let currentScanner = null;
let lastScannedId = null;
let lastScannedAt = 0;
const DEBOUNCE_MS = 1500; // Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø± Ø§Ù„Ø³Ø±ÙŠØ¹

// Beep sound
const beepBase64 = "UklGRuQAAABXQVZFZm10IBAAAAABAAEAgD4AAAB9AAACABAAZGF0YcQAAACAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA=";
const beepSound = new Audio("data:audio/wav;base64," + beepBase64);
beepSound.volume = 1.0;
function playBeep(){ try{ beepSound.currentTime = 0; beepSound.play(); }catch(e){ console.warn('beep failed', e); } try{ if(navigator.vibrate) navigator.vibrate(180); } catch(e){} }

function showConfirmation(record){ const msg = document.getElementById('confirmMsg'); msg.textContent = `âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ ${record.movement} Ù„Ù€ ${record.name}`; msg.style.display = 'block'; setTimeout(()=>{ msg.style.display = 'none'; }, 2000); }

function updateCounter(){ document.getElementById('scanCount').innerText = 'Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø³Ø¬Ù„Ø©: ' + scanCount; }

function createLocalRecord(employeeId, movement){ const now = new Date(); return { id: `local-${Date.now()}-${Math.random().toString(36).slice(2,8)}`, name: String(employeeId).trim(), movement: movement, timestamp: now.toISOString(), date: now.toLocaleDateString('ar-EG'), time: now.toLocaleTimeString('ar-EG'), source: 'QR' }; }

// Scanner functions (Ù…Ø«Ù„ Ø§Ù„Ø£ØµÙ„ÙŠØ©)
function startScanner(){ if(currentScanner) return; const readerId = "reader"; const html5Qr = new Html5Qrcode(readerId); currentScanner = html5Qr; const config = { fps: 10, qrbox: { width: 250, height: 250 } };
  Html5Qrcode.getCameras().then(devices => {
    if(devices && devices.length){
      const rear = devices.find(d => (d.label||'').toLowerCase().includes('back') || (d.label||'').toLowerCase().includes('rear')) || devices[0];
      html5Qr.start(rear.id || { facingMode: "environment" }, config, qrCodeMessage => {
        const now = Date.now();
        if(qrCodeMessage === lastScannedId && (now - lastScannedAt) < DEBOUNCE_MS) return;
        lastScannedId = qrCodeMessage; lastScannedAt = now;
        html5Qr.stop().then(()=>{ currentScanner = null; handleScanned(qrCodeMessage); setTimeout(()=> startScanner(), 600); }).catch(err=>{ currentScanner = null; handleScanned(qrCodeMessage); setTimeout(()=> startScanner(), 600); });
      }, errorMessage => {}).catch(err=>{ console.error('start failed', err); const msg = document.getElementById('confirmMsg'); msg.textContent = 'Ø®Ø·Ø£: Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª.'; msg.style.display = 'block'; setTimeout(()=> msg.style.display='none',3000); });
    } else { const msg = document.getElementById('confirmMsg'); msg.textContent = 'Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙƒØ§Ù…ÙŠØ±Ø§.'; msg.style.display = 'block'; setTimeout(()=> msg.style.display='none',3000); }
  }).catch(err=>{ console.error('cameras error', err); }); }

function stopScanner(){ if(!currentScanner) return; currentScanner.stop().then(()=>{ try{ currentScanner.clear(); }catch(e){}; currentScanner = null; const msg = document.getElementById('confirmMsg'); msg.textContent = 'ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø§Ø³Ø­.'; msg.style.display = 'block'; setTimeout(()=> msg.style.display='none',1500); }).catch(err=>{ console.warn('stop err', err); currentScanner = null; }); }

function handleScanned(qr){ const movement = document.getElementById('movementSelect').value; if(!movement){ const msg = document.getElementById('confirmMsg'); msg.textContent = 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ø­Ø±ÙƒØ© Ø£ÙˆÙ„Ø§Ù‹.'; msg.style.display = 'block'; setTimeout(()=> msg.style.display='none',1800); return; }
  const record = createLocalRecord(qr, movement); records.unshift(record); scanCount++; updateCounter(); saveLocally(); sendToGoogle(record); playBeep(); showConfirmation(record); }

function manualAdd(){ const val = document.getElementById('manualInput').value; const movement = document.getElementById('movementSelect').value; if(!movement){ alert('Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø­Ø±ÙƒØ© Ø£ÙˆÙ„Ø§Ù‹'); return; } if(!val || String(val).trim()===''){ alert('Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø£Ùˆ Ø§Ø³Ù… ØµØ§Ù„Ø­'); return; } const record = createLocalRecord(val, movement); records.unshift(record); scanCount++; updateCounter(); saveLocally(); sendToGoogle(record); playBeep(); showConfirmation(record); document.getElementById('manualInput').value=''; }

function saveLocally(){ try{ localStorage.setItem('attendance_records_v3', JSON.stringify(records)); }catch(e){} }
function loadLocally(){ try{ const s = localStorage.getItem('attendance_records_v3'); if(s){ records = JSON.parse(s); scanCount = records.length; updateCounter(); } }catch(e){} }

function exportToExcel(){ const data = records.slice().sort((a,b)=> new Date(b.timestamp) - new Date(a.timestamp)); const headers = ['Ù…Ø¹Ø±Ù Ø§Ù„Ø³Ø¬Ù„','Ø±Ù…Ø² Ø§Ù„Ù…ÙˆØ¸Ù','Ù†ÙˆØ¹ Ø§Ù„Ø­Ø±ÙƒØ©','Ø§Ù„ÙˆÙ‚Øª','Ø§Ù„Ù…ØµØ¯Ø±']; let csv = headers.join(',') + '\n'; const esc = v => { if(v==null) return ''; let s = String(v); if(s.includes(',')||s.includes('\n')||s.includes('"')) return '"' + s.replace(/"/g,'""') + '"'; return s; };
  data.forEach(r=>{ csv += [esc(r.id), esc(r.name), esc(r.movement), esc(new Date(r.timestamp).toLocaleString('en-US',{hour12:false})), esc(r.source)].join(',') + '\n'; });
  const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `Attendance_Records_${new Date().toISOString().slice(0,10)}.csv`; document.body.appendChild(a); a.click(); a.remove(); }

function sendToGoogle(record){ try{ const params = new URLSearchParams(); params.append('records_batch', JSON.stringify([{ id: record.id, employee_id: record.name, movement_type: record.movement, timestamp: record.timestamp, source: record.source }])); // use no-cors for beacon fallback
    fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: params.toString() })
    .catch(e=>{ try{ if(navigator.sendBeacon){ const blob = new Blob([params.toString()], { type: 'application/x-www-form-urlencoded' }); navigator.sendBeacon(GOOGLE_SCRIPT_URL, blob); } }catch(_){} }); }catch(e){ console.warn(e); } }

// Init & Controls
document.getElementById('startBtn').addEventListener('click', startScanner);
document.getElementById('stopBtn').addEventListener('click', stopScanner);
document.getElementById('manualAddBtn').addEventListener('click', manualAdd);
document.getElementById('exportBtn').addEventListener('click', exportToExcel);

loadLocally();

// Service Worker registration for PWA (if hosted)
if('serviceWorker' in navigator){ window.addEventListener('load', ()=>{ navigator.serviceWorker.register('service-worker.js').then(()=>console.log('SW registered')).catch(()=>{}); }); }

// Update offline status in sidebar
function updateOnlineStatus(){ const el = document.getElementById('offlineStatus'); el.innerHTML = navigator.onLine ? 'âš¡<div style="font-size:11px;margin-top:6px">Ù…ØªØµÙ„</div>' : 'â›”<div style="font-size:11px;margin-top:6px">ØºÙŠØ± Ù…ØªØµÙ„</div>'; }
window.addEventListener('online', updateOnlineStatus); window.addEventListener('offline', updateOnlineStatus); updateOnlineStatus();
</script>
</body>
</html>
