<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø¶ÙˆØ± - Ù…ØªØ±Ùˆ Ø£Ø¨Ùˆ Ù‚ÙŠØ±</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#10b981"/>
<style>
  :root {
    --primary: #10b981;
    --secondary: #3b82f6;
    --danger: #ef4444;
    --warning: #f59e0b;
    --dark: #06212a;
  }
  
  body{font-family:"Cairo", Arial, sans-serif;background:#f3f4f6;color:#111;padding:0;margin:0;direction:rtl}
  .app{display:flex;min-height:100vh}
  .sidebar{width:72px;background:var(--dark);color:#fff;display:flex;flex-direction:column;align-items:center;padding:12px;gap:12px;transition:all 0.3s}
  .sidebar a{color:#fff;text-decoration:none;font-size:12px;text-align:center;transition:transform 0.2s}
  .sidebar a:hover{transform:translateY(-2px)}
  .main{flex:1;padding:18px}
  .card{max-width:720px;margin:18px auto;background:#fff;padding:24px;border-radius:16px;box-shadow:0 8px 32px rgba(0,0,0,0.1);border:1px solid #e5e7eb}
  h1{font-size:22px;margin:0 0 15px;color:var(--dark);text-align:center}
  .controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap;justify-content:center;margin-bottom:18px;padding:15px;background:#f8fafc;border-radius:12px}
  select,input[type=text]{padding:12px;border-radius:10px;border:1px solid #d1d5db;font-size:16px;font-family:"Cairo";width:180px;background:white}
  button{padding:12px 18px;border-radius:10px;border:none;color:#fff;font-weight:600;cursor:pointer;font-family:"Cairo";font-size:15px;transition:all 0.2s;min-width:120px}
  button:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,0.15)}
  #startBtn{background:var(--primary)}
  #stopBtn{background:var(--danger)}
  #exportBtn{background:#06b6d4}
  #syncBtn{background:#8b5cf6}
  #reader{width:100%;max-width:480px;margin:15px auto;border-radius:12px;overflow:hidden;background:#000;box-shadow:0 8px 25px rgba(0,0,0,0.2)}
  .confirmation-message{position:fixed;top:20px;left:50%;transform:translateX(-50%);background:rgba(16,185,129,0.95);color:#fff;padding:12px 20px;border-radius:10px;z-index:9999;display:none;font-weight:700;box-shadow:0 4px 15px rgba(16,185,129,0.3);backdrop-filter:blur(10px)}
  .error-message{position:fixed;top:20px;left:50%;transform:translateX(-50%);background:rgba(239,68,68,0.95);color:#fff;padding:12px 20px;border-radius:10px;z-index:9999;display:none;font-weight:700;box-shadow:0 4px 15px rgba(239,68,68,0.3);backdrop-filter:blur(10px)}
  .counter{font-weight:700;color:#065f46;font-size:16px;background:white;padding:10px 15px;border-radius:8px;border:2px solid #d1fae5}
  .manual-row{display:flex;gap:10px;justify-content:center;align-items:center;margin-top:15px;flex-wrap:wrap}
  .small{font-size:14px;color:#6b7280}
  .link-icon{writing-mode:vertical-rl;transform:rotate(180deg);font-weight:700}
  .pending-badge{background:var(--warning);color:white;padding:4px 8px;border-radius:12px;font-size:12px;margin-right:8px}
  .status-indicator{width:8px;height:8px;border-radius:50%;display:inline-block;margin-left:5px}
  .status-online{background:#10b981}
  .status-offline{background:#ef4444}
  .sync-animation{animation:pulse 1.5s infinite}
  
  @keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
  }
  
  @media (max-width:720px){ 
    .sidebar{width:60px;padding:8px} 
    .card{padding:15px;margin:10px}
    .controls{gap:8px}
    select,input[type=text]{width:140px;padding:10px}
    button{min-width:100px;padding:10px 12px}
  }
</style>
</head>
<body>
<div class="app">
  <nav class="sidebar" role="navigation" aria-label="Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©">
    <a href="index.html" title="Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©">ğŸ <div style="font-size:11px;margin-top:6px">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div></a>
    <a href="reports.html" title="Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±">ğŸ“Š<div style="font-size:11px;margin-top:6px">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</div></a>
    <a href="#" id="offlineStatus" title="Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„">
      âš¡<div style="font-size:11px;margin-top:6px">Ù…ØªØµÙ„<span class="status-indicator status-online"></span></div>
    </a>
  </nav>

  <main class="main">
    <div class="card">
      <center><h1>Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø¶ÙˆØ± - Ù…ØªØ±Ùˆ Ø£Ø¨Ùˆ Ù‚ÙŠØ±</h1></center>
      <div class="controls" role="region" aria-label="Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª">
        <label for="movementSelect" class="small">Ù†ÙˆØ¹ Ø§Ù„Ø­Ø±ÙƒØ©:</label>
        <select id="movementSelect" aria-label="Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ø­Ø±ÙƒØ©">
          <option value="">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø­Ø±ÙƒØ©</option>
          <option value="Ø¯Ø®ÙˆÙ„">Ø¯Ø®ÙˆÙ„</option>
          <option value="Ø§Ù†ØµØ±Ø§Ù">Ø§Ù†ØµØ±Ø§Ù</option>
          <option value="Ø§Ù†ØµØ±Ø§Ù Ù…Ø³Ø§Ø¦ÙŠ">Ø§Ù†ØµØ±Ø§Ù Ù…Ø³Ø§Ø¦ÙŠ</option>
        </select>

        <div class="counter" id="scanCount">
          Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø§Ù„Ø§Øª: 0 
          <span id="pendingCount" class="pending-badge" style="display:none">0</span>
        </div>

        <button id="stopBtn">Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø§Ø³Ø­</button>
        <button id="startBtn">ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø§Ø³Ø­</button>
        <button id="syncBtn">ğŸ”„ Ù…Ø²Ø§Ù…Ù†Ø©</button>
      </div>

      <div id="reader" aria-live="polite"></div>

      <div class="manual-row">
        <input type="text" id="manualInput" placeholder="Ø¥Ø¯Ø®Ø§Ù„ ÙŠØ¯ÙˆÙŠ - Ø±Ù‚Ù… Ø£Ùˆ Ø§Ø³Ù…" aria-label="Ø¥Ø¯Ø®Ø§Ù„ ÙŠØ¯ÙˆÙŠ">
        <button id="manualAddBtn">â• Ø¥Ø¶Ø§ÙØ© ÙŠØ¯ÙˆÙŠ</button>
      </div>

      <div style="text-align:center;margin-top:20px">
        <button id="exportBtn">ğŸ“¥ ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Excel</button>
      </div>

      <p class="small" style="margin-top:15px;text-align:center;color:#374151">
        Ù‚Ø³Ù… Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ© - Ù…ØªØ±Ùˆ Ø£Ø¨Ùˆ Ù‚ÙŠØ±
      </p>
    </div>

    <div id="confirmMsg" class="confirmation-message" role="status" aria-live="polite"></div>
    <div id="errorMsg" class="error-message" role="alert" aria-live="polite"></div>
  </main>
</div>

<script src="https://unpkg.com/html5-qrcode"></script>
<script>
// ---------------- CONFIG ----------------
const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzeBugfSme93srGaJa5h5Kf_pFreNh9PgB39WAYq_VFryNRR2u8eMUkgaIwHNiVy0zA1A/exec';

// ---------------- State ----------------
let records = [];
let pendingRecords = [];
let scanCount = 0;
let currentScanner = null;
let lastScannedId = null;
let lastScannedAt = 0;
const DEBOUNCE_MS = 1500;

// Improved beep sound
const beepBase64 = "UklGRuQAAABXQVZFZm10IBAAAAABAAEAgD4AAAB9AAACABAAZGF0YcQAAACAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA=";
const beepSound = new Audio("data:audio/wav;base64," + beepBase64);
beepSound.volume = 0.7;

function playBeep(){ 
  try{ 
    beepSound.currentTime = 0; 
    beepSound.play(); 
  }catch(e){ console.warn('beep failed', e); } 
  try{ 
    if(navigator.vibrate) navigator.vibrate(100); 
  } catch(e){}
}

function showConfirmation(record){ 
  const msg = document.getElementById('confirmMsg');
  msg.textContent = `âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ ${record.movement_type} Ù„Ù€ ${record.employee_id}`;
  msg.style.display = 'block'; 
  setTimeout(()=>{ msg.style.display = 'none'; }, 2500); 
}

function showError(message) {
  const msg = document.getElementById('errorMsg');
  msg.textContent = message;
  msg.style.display = 'block';
  setTimeout(()=>{ msg.style.display = 'none'; }, 4000);
}

function updateCounter(){ 
  document.getElementById('scanCount').innerHTML = `Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø§Ù„Ø§Øª: <strong>${scanCount}</strong>`; 
  const pendingEl = document.getElementById('pendingCount');
  if (pendingRecords.length > 0) {
    pendingEl.textContent = pendingRecords.length;
    pendingEl.style.display = 'inline';
  } else {
    pendingEl.style.display = 'none';
  }
}

function createLocalRecord(employeeId, movement, source = 'QR'){ 
  const now = new Date();
  return { 
    id: `local-${Date.now()}-${Math.random().toString(36).slice(2,8)}`,
    employee_id: String(employeeId).trim(), 
    movement_type: movement, 
    timestamp: now.toISOString(),
    source: source,
    date: now.toISOString().split('T')[0],
    time: now.toTimeString().split(' ')[0].substring(0,5)
  }; 
}

// Scanner functions
function startScanner(){ 
  if(currentScanner) return; 
  
  const movement = document.getElementById('movementSelect').value; 
  if(!movement){ 
    showError('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ø­Ø±ÙƒØ© Ø£ÙˆÙ„Ø§Ù‹.');
    return; 
  }
  
  const readerId = "reader"; 
  const html5Qr = new Html5Qrcode(readerId); 
  currentScanner = html5Qr; 
  const config = { fps: 10, qrbox: { width: 250, height: 250 } };
  
  Html5Qrcode.getCameras().then(devices => {
    if(devices && devices.length){
      const rear = devices.find(d => (d.label||'').toLowerCase().includes('back') || (d.label||'').toLowerCase().includes('rear')) || devices[0];
      html5Qr.start(rear.id || { facingMode: "environment" }, config, qrCodeMessage => {
        const now = Date.now();
        if(qrCodeMessage === lastScannedId && (now - lastScannedAt) < DEBOUNCE_MS) return;
        lastScannedId = qrCodeMessage; 
        lastScannedAt = now;
        html5Qr.stop().then(()=>{ 
          currentScanner = null; 
          handleScanned(qrCodeMessage); 
          setTimeout(()=> startScanner(), 500); 
        }).catch(err=>{ 
          currentScanner = null; 
          handleScanned(qrCodeMessage); 
          setTimeout(()=> startScanner(), 500); 
        });
      }, errorMessage => {}).catch(err=>{ 
        console.error('start failed', err); 
        showError('Ø®Ø·Ø£: Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª.');
      });
    } else { 
      showError('Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙƒØ§Ù…ÙŠØ±Ø§.');
    }
  }).catch(err=>{ 
    console.error('cameras error', err); 
    showError('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§');
  }); 
}

function stopScanner(){ 
  if(!currentScanner) return; 
  currentScanner.stop().then(()=>{ 
    try{ currentScanner.clear(); }catch(e){}; 
    currentScanner = null; 
    showConfirmation({movement_type: '', employee_id: 'ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø§Ø³Ø­.'});
  }).catch(err=>{ 
    console.warn('stop err', err); 
    currentScanner = null; 
  }); 
}

function handleScanned(qr){ 
  const movement = document.getElementById('movementSelect').value; 
  const record = createLocalRecord(qr, movement); 
  records.unshift(record);
  pendingRecords.push(record);
  scanCount++; 
  updateCounter(); 
  saveLocally(); 
  sendToGoogle([record]); 
  playBeep(); 
  showConfirmation(record); 
}

function manualAdd(){ 
  const val = document.getElementById('manualInput').value.trim(); 
  const movement = document.getElementById('movementSelect').value; 
  if(!movement){ 
    showError('Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø­Ø±ÙƒØ© Ø£ÙˆÙ„Ø§Ù‹'); 
    return; 
  } 
  if(!val){ 
    showError('Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø£Ùˆ Ø§Ø³Ù… ØµØ§Ù„Ø­'); 
    return; 
  } 
  
  const record = createLocalRecord(val, movement, 'Manual'); 
  records.unshift(record);
  pendingRecords.push(record);
  scanCount++; 
  updateCounter(); 
  saveLocally(); 
  sendToGoogle([record]); 
  playBeep(); 
  showConfirmation(record); 
  document.getElementById('manualInput').value=''; 
}

function saveLocally(){ 
  try{ 
    localStorage.setItem('attendance_records_final', JSON.stringify(records));
    localStorage.setItem('pending_records_final', JSON.stringify(pendingRecords));
    localStorage.setItem('scan_count_final', scanCount.toString());
  }catch(e){} 
}

function loadLocally(){ 
  try{ 
    const s = localStorage.getItem('attendance_records_final');
    const p = localStorage.getItem('pending_records_final');
    const c = localStorage.getItem('scan_count_final');
    
    if(s) records = JSON.parse(s); 
    if(p) pendingRecords = JSON.parse(p);
    if(c) scanCount = parseInt(c);
    
    updateCounter(); 
  }catch(e){} 
}

function exportToExcel(){ 
  const data = records.slice().sort((a,b)=> new Date(b.timestamp) - new Date(a.timestamp)); 
  const headers = ['Ù…Ø¹Ø±Ù Ø§Ù„Ø³Ø¬Ù„','Ø±Ù…Ø² Ø§Ù„Ù…ÙˆØ¸Ù','Ù†ÙˆØ¹ Ø§Ù„Ø­Ø±ÙƒØ©','Ø§Ù„ÙˆÙ‚Øª','Ø§Ù„Ù…ØµØ¯Ø±', 'Ø§Ù„Ø­Ø§Ù„Ø©']; 
  let csv = headers.join(',') + '\n'; 
  const esc = v => { 
    if(v==null) return ''; 
    let s = String(v); 
    if(s.includes(',')||s.includes('\n')||s.includes('"')) return '"' + s.replace(/"/g,'""') + '"'; 
    return s; 
  };
  
  data.forEach(r=>{ 
    const status = !pendingRecords.find(p => p.id === r.id) ? 'Ù…Ø²Ø§Ù…Ù†' : 'ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±';
    csv += [esc(r.id), esc(r.employee_id), esc(r.movement_type), esc(new Date(r.timestamp).toLocaleString('ar-EG')), esc(r.source), esc(status)].join(',') + '\n'; 
  });
  
  const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' }); 
  const a = document.createElement('a'); 
  a.href = URL.createObjectURL(blob); 
  a.download = `Ø³Ø¬Ù„Ø§Øª_Ø§Ù„Ø­Ø¶ÙˆØ±_${new Date().toISOString().slice(0,10)}.csv`; 
  document.body.appendChild(a); 
  a.click(); 
  a.remove(); 
}

// Improved Google Apps Script communication
function sendToGoogle(recordsToSend) {
  if (!Array.isArray(recordsToSend) || recordsToSend.length === 0) return;

  if (!navigator.onLine) {
    console.log('Offline - records saved locally, will sync when online');
    return;
  }

  const payload = {
    action: 'saveRecords',
    records: recordsToSend,
    timestamp: new Date().toISOString(),
    source: 'attendance_app'
  };

  fetch(GOOGLE_SCRIPT_URL, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(payload)
  })
  .then(response => {
    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
    return response.json();
  })
  .then(result => {
    console.log('Server response:', result);
    if (result.success) {
      const syncedIds = result.saved_records.map(r => r.id);
      pendingRecords = pendingRecords.filter(record => !syncedIds.includes(record.id));
      updateCounter();
      saveLocally();
      
      if (syncedIds.length > 0) {
        showConfirmation({movement_type: '', employee_id: `ØªÙ…Øª Ù…Ø²Ø§Ù…Ù†Ø© ${syncedIds.length} Ø³Ø¬Ù„`});
      }
    } else {
      console.error('Server reported error:', result.error);
    }
  })
  .catch(error => {
    console.error('Network error:', error);
    // Retry with FormData as fallback
    retryWithFormData(recordsToSend);
  });
}

function retryWithFormData(recordsToSend) {
  const formData = new URLSearchParams();
  formData.append('action', 'saveRecords');
  formData.append('records', JSON.stringify(recordsToSend));

  fetch(GOOGLE_SCRIPT_URL, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
    },
    body: formData
  })
  .then(response => response.json())
  .then(result => {
    if (result.success) {
      const syncedIds = result.saved_records.map(r => r.id);
      pendingRecords = pendingRecords.filter(record => !syncedIds.includes(record.id));
      updateCounter();
      saveLocally();
    }
  })
  .catch(error => {
    console.error('FormData also failed:', error);
  });
}

function syncPendingRecords() {
  if (pendingRecords.length === 0) {
    showConfirmation({movement_type: '', employee_id: 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø©'});
    return;
  }

  if (!navigator.onLine) {
    showError('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª. Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©.');
    return;
  }

  const syncBtn = document.getElementById('syncBtn');
  syncBtn.innerHTML = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©...';
  syncBtn.classList.add('sync-animation');

  showConfirmation({movement_type: '', employee_id: `Ø¬Ø§Ø±ÙŠ Ù…Ø²Ø§Ù…Ù†Ø© ${pendingRecords.length} Ø³Ø¬Ù„...`});

  sendToGoogle(pendingRecords);

  setTimeout(() => {
    syncBtn.innerHTML = 'ğŸ”„ Ù…Ø²Ø§Ù…Ù†Ø©';
    syncBtn.classList.remove('sync-animation');
  }, 3000);
}

// Event Listeners
document.getElementById('startBtn').addEventListener('click', startScanner);
document.getElementById('stopBtn').addEventListener('click', stopScanner);
document.getElementById('manualAddBtn').addEventListener('click', manualAdd);
document.getElementById('exportBtn').addEventListener('click', exportToExcel);
document.getElementById('syncBtn').addEventListener('click', syncPendingRecords);
document.getElementById('manualInput').addEventListener('keypress', function(e) {
  if (e.key === 'Enter') manualAdd();
});

// Load saved data
loadLocally();

// PWA Service Worker
if('serviceWorker' in navigator){ 
  window.addEventListener('load', ()=>{ 
    navigator.serviceWorker.register('service-worker.js')
      .then(()=>console.log('SW registered'))
      .catch(()=>{}); 
  }); 
}

// Online/Offline status
function updateOnlineStatus(){ 
  const el = document.getElementById('offlineStatus'); 
  const indicator = el.querySelector('.status-indicator');
  
  if (navigator.onLine) {
    el.innerHTML = 'âš¡<div style="font-size:11px;margin-top:6px">Ù…ØªØµÙ„<span class="status-indicator status-online"></span></div>';
    // Auto-sync when coming back online
    if (pendingRecords.length > 0) {
      setTimeout(() => {
        showConfirmation({movement_type: '', employee_id: 'Ø§Ù„Ø§ØªØµØ§Ù„ Ù…ØªØ§Ø­ - Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©...'});
        syncPendingRecords();
      }, 2000);
    }
  } else {
    el.innerHTML = 'â›”<div style="font-size:11px;margin-top:6px">ØºÙŠØ± Ù…ØªØµÙ„<span class="status-indicator status-offline"></span></div>';
  }
}

window.addEventListener('online', updateOnlineStatus); 
window.addEventListener('offline', updateOnlineStatus); 
updateOnlineStatus();

// Test connection on load
window.addEventListener('load', function() {
  // Set default movement type to "Ø¯Ø®ÙˆÙ„"
  document.getElementById('movementSelect').value = 'Ø¯Ø®ÙˆÙ„';
  
  fetch(GOOGLE_SCRIPT_URL + '?action=test')
    .then(response => {
      if (response.ok) {
        console.log('Connection to Google Apps Script is working');
      }
    })
    .catch(error => {
      console.log('Connection test failed (might be offline)');
    });
});
</script>
</body>
</html>
